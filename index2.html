<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Арманым сен — Аккордтармен</title>
  <style>
    :root{
      --bg:#0b0b12;--card:#111423;--text:#e9ecf4;--muted:#aab3c6;--accent:#6aa9ff;--chip:#1b2240;--radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:radial-gradient(1200px 800px at 20% 0%,#152042 0,#0b0b12 45%),var(--bg);color:var(--text);line-height:1.75;}
    .wrap{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;gap:12px;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{font-size:24px;font-weight:800;letter-spacing:.3px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .control{background:var(--card);border:1px solid #1e2340;border-radius:var(--radius);padding:8px 12px;color:var(--text)}
    select,button{background:#0e1531;border:1px solid #283259;color:var(--text);padding:8px 10px;border-radius:10px}
    .card{background:rgba(17,20,35,.7);border:1px solid #222a4f;backdrop-filter: blur(8px);border-radius:var(--radius);padding:18px 16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .progression{display:flex;flex-wrap:wrap;gap:6px;margin:12px 0 18px}
    .chip{background:var(--chip);border:1px solid #2a3260;color:#dbe6ff;padding:6px 10px;border-radius:10px;font-weight:700}
    .section{margin:18px 0}
    .section h3{font-size:13px;letter-spacing:.08em;color:var(--muted);text-transform:uppercase;margin-bottom:6px}
    .line{display:flex;gap:10px;align-items:flex-start;margin:2px 0}
    .ch{min-width:62px;font-weight:800;color:#bcd7ff;text-shadow:0 0 8px #2748ff}
    .lyr{white-space:pre-wrap}
    footer{opacity:.7;margin-top:18px;font-size:12px}
    .kbd{font-family:ui-monospace,Consolas,monospace;background:#0b1230;border:1px solid #283259;border-radius:8px;padding:2px 6px}
    @media (max-width:640px){.ch{min-width:48px}}

    /* ===== Popover (аккорд-диаграмма) ===== */
.chx, .chip.chrd{cursor:pointer;position:relative}
.popover{
  position:fixed;z-index:9999;background:#1b1f34;border:1px solid #2b3157;
  box-shadow:0 14px 40px rgba(0,0,0,.45);border-radius:14px;min-width:220px;padding:12px
}
.popover h4{margin:0 0 8px;font-size:16px;color:#ffd8f2}
.fret-wrap{display:flex;gap:8px}
.strings{display:flex;flex-direction:column;justify-content:space-between;font-size:10px;color:#9fb0ff;opacity:.9;padding-right:4px}
.fret svg{display:block}
.pop-foot{display:flex;justify-content:space-between;align-items:center;margin-top:8px;color:#9fb0ff;font-size:12px}
.pop-close{background:none;border:none;color:#9fb0ff;cursor:pointer}
.pop-title{display:flex;gap:6px;align-items:baseline}
.badge{font-size:11px;color:#b3c4ff}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Арманым сен — аккордтармен</h1>
      <div class="controls">
        <label class="control">Тональность: 
          <select id="transpose">
            <option value="0">Bm (ориг.)</option>
            <option value="-2">Am</option>
            <option value="-1">Bbm</option>
            <option value="1">Cm</option>
            <option value="2">C#m</option>
            <option value="3">Dm</option>
            <option value="4">D#m</option>
            <option value="5">Em</option>
            <option value="7">F#m</option>
            <option value="9">G#m</option>
            <option value="10">Am (каподастр II)</option>
          </select>
        </label>
        <button id="copyBtn" title="Көшіру"><span>Текст + аккордтарды көшіру</span></button>
      </div>
    </header>

    <div class="card">
      <div class="section">
        <h3>Intro</h3>
        <div class="progression" id="intro">
          <span class="chip chrd">Bm</span><span class="chip chrd">G</span><span class="chip chrd">F#</span>
          <span class="chip chrd">Bm</span><span class="chip chrd">A</span><span class="chip chrd">Bm</span>
          <span class="chip chrd">D</span><span class="chip chrd">A</span><span class="chip chrd">D</span><span class="chip chrd">F#</span>
          <span class="chip chrd">G</span><span class="chip chrd">A</span><span class="chip chrd">Bm</span>
        </div>
      </div>

      <div class="section">
        <h3>Verse 1</h3>
        <div class="line"><div class="ch chrd">Bm  A</div><div class="lyr">Менің армандаған ойларымның</div></div>
        <div class="line"><div class="ch chrd">G   A   D</div><div class="lyr">Жиынтығы болған аруым</div></div>
        <div class="line"><div class="ch chrd">G   A   D</div><div class="lyr">Жан-тәніммен мен саған зәрумін</div></div>
        <div class="line"><div class="ch chrd">G       F#</div><div class="lyr">Күші жетпес емдеуге дәрінің</div></div>
      </div>

      <div class="section">
        <h3>Verse 2</h3>
        <div class="line"><div class="ch chrd">Bm  A</div><div class="lyr">Арманым — сенің мендік болуың</div></div>
        <div class="line"><div class="ch chrd">G    A     D</div><div class="lyr">Бақ құсым боп қолға қонуың</div></div>
        <div class="line"><div class="ch chrd">G    A     D</div><div class="lyr">Сенімді серігім боп жүруің</div></div>
        <div class="line"><div class="ch chrd">G    A     Bm</div><div class="lyr">Іштегі от сезімімді көруің</div></div>
      </div>

      <div class="section">
        <h3>Pre-chorus</h3>
        <div class="line"><div class="ch chrd">Bm  A   Bm</div><div class="lyr">Түннің тұнығындай</div></div>
        <div class="line"><div class="ch chrd">G       A    Bm</div><div class="lyr">Қыс ауасының суығындай</div></div>
        <div class="line"><div class="ch chrd">G    A     Bm</div><div class="lyr">Жалындай жанған жанымды емде</div></div>
        <div class="line"><div class="ch chrd">G        F#</div><div class="lyr">Ешкімге жүрек кілтін берме</div></div>
      </div>

      <div class="section">
        <h3>Chorus</h3>
        <div class="line"><div class="ch chrd">G     A      D</div><div class="lyr">Сені қатты сағынған күндері</div></div>
        <div class="line"><div class="ch chrd">G       A        D</div><div class="lyr">Сенсіз қатты қиналған кездерім</div></div>
        <div class="line"><div class="ch chrd">G      A      Bm</div><div class="lyr">«Мен сені сүйем» деген сөздерім ернімде</div></div>
        <div class="line"><div class="ch chrd">G      A        Bm</div><div class="lyr">Тағы да жасаурайды жүрегім</div></div>
        <div class="line"><div class="ch chrd">G        A        Bm</div><div class="lyr">Сені әлі сағынады — білемін</div></div>
        <div class="line"><div class="ch chrd">G        A         Bm</div><div class="lyr">Жаным, сүйем, сені әлі күтемін</div></div>
      </div>

      <div class="section">
        <h3>Outro</h3>
        <div class="progression" id="outro">
          <span class="chip chrd">Bm</span><span class="chip chrd">G</span><span class="chip chrd">F#</span>
          <span class="chip chrd">Bm</span><span class="chip chrd">A</span><span class="chip chrd">Bm</span>
          <span class="chip chrd">F#</span><span class="chip chrd">G</span><span class="chip chrd">F#</span><span class="chip chrd">Bm</span>
        </div>
      </div>
      <footer>
        Кеңес: транспозицияны өзгерту үшін пернетақтадан <span class="kbd">[</span>/<span class="kbd">]</span> басыңыз.
      </footer>
    </div>
  </div>

  <script>
    // --- Транспонирование ---
    const NOTES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const FLAT_MAP = {"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#"};

    function splitChord(ch){
      // e.g., F#m7b5 -> root F#, quality m7b5
      const m = ch.match(/^([A-G](?:#|b)?)(.*)$/);
      return m ? {root: FLAT_MAP[m[1]]||m[1], qual:m[2]||""} : {root:ch, qual:""};
    }

    function transposeChord(ch, steps){
      if(!ch || ch==='—' || ch==='-') return ch;
      const {root,qual} = splitChord(ch);
      const i = NOTES.indexOf(root);
      if(i<0) return ch;
      let ni = (i + steps + 120) % 12;
      return NOTES[ni] + qual;
    }

    function transposeAll(steps){
      document.querySelectorAll('.chrd').forEach(el=>{
        const orig = el.getAttribute('data-orig') || el.textContent.trim();
        el.setAttribute('data-orig', orig);
        // делаем каждый аккорд кликабельным
        el.innerHTML = orig.split(/\s+/)
          .map(tok => {
            const t = transposeChord(tok, steps);
            return `<span class="chx" data-chord="${t}">${t}</span>`;
          })
          .join(' ');
      });
    }

    const select = document.getElementById('transpose');
    select.addEventListener('change', e=> transposeAll(parseInt(e.target.value,10)) );

    // keyboard shortcuts [ ]
    window.addEventListener('keydown', (e)=>{
      if(e.key==='['){ select.selectedIndex = Math.max(0, select.selectedIndex-1); select.dispatchEvent(new Event('change')); }
      if(e.key===']'){ select.selectedIndex = Math.min(select.options.length-1, select.selectedIndex+1); select.dispatchEvent(new Event('change')); }
    });

    // copy
    document.getElementById('copyBtn').addEventListener('click', ()=>{
      let txt = '';
      document.querySelectorAll('.section').forEach(sec=>{
        const title = sec.querySelector('h3')?.textContent?.trim() || '';
        if(title) txt += `\n${title}\n`;
        sec.querySelectorAll('.line').forEach(line=>{
          const ch = line.querySelector('.ch')?.textContent?.trim() || '';
          const ly = line.querySelector('.lyr')?.textContent?.trim() || '';
          txt += `${ch}\t${ly}\n`;
        });
        sec.querySelectorAll('.chip.chrd').forEach(c=>{ txt += c.textContent+ ' '; });
        if(sec.querySelector('.chip')) txt += '\n';
      });
      navigator.clipboard.writeText(txt.trim()).then(()=>{
        const btn = document.getElementById('copyBtn');
        const prev = btn.textContent; btn.textContent='Көшірілді!';
        setTimeout(()=>btn.textContent=prev,1200);
      });
    });


    // ===== Библиотека форм аккордов (стандартные аппликатуры) =====
// Массив 6 струн: E A D G B e; число=лад, 0=открытая, -1=глушим
const CHORD_SHAPES = {
  // Majors
  'A':[-1,0,2,2,2,0], 'Bb':[-1,1,3,3,3,1], 'A#':[-1,1,3,3,3,1],
  'B':[-1,2,4,4,4,2], 'C':[-1,3,2,0,1,0],
  'C#':[-1,4,6,6,6,4], 'Db':[-1,4,6,6,6,4],
  'D':[-1,-1,0,2,3,2], 'D#':[-1,-1,1,3,4,3], 'Eb':[-1,-1,1,3,4,3],
  'E':[0,2,2,1,0,0], 'F':[1,3,3,2,1,1],
  'F#':[2,4,4,3,2,2], 'Gb':[2,4,4,3,2,2],
  'G':[3,2,0,0,0,3], 'G#':[4,6,6,5,4,4], 'Ab':[4,6,6,5,4,4],
  // Minors
  'Am':[-1,0,2,2,1,0], 'A#m':[-1,1,3,3,2,1], 'Bbm':[-1,1,3,3,2,1],
  'Bm':[-1,2,4,4,3,2], 'Cm':[-1,3,5,5,4,3],
  'C#m':[-1,4,6,6,5,4], 'Dbm':[-1,4,6,6,5,4],
  'Dm':[-1,-1,0,2,3,1], 'D#m':[-1,-1,1,3,4,2], 'Ebm':[-1,-1,1,3,4,2],
  'Em':[0,2,2,0,0,0], 'Fm':[1,3,3,1,1,1],
  'F#m':[2,4,4,2,2,2], 'Gbm':[2,4,4,2,2,2],
  'Gm':[3,5,5,3,3,3], 'G#m':[4,6,6,4,4,4], 'Abm':[4,6,6,4,4,4]
};

let pop;
function encodeShape(arr){ return arr.map(v=> v<0 ? 'x' : String(v)).join(''); }

function drawChord(label, arr){
  const frets = arr.filter(v=>v>0);
  const min = frets.length ? Math.min(...frets) : 0;
  const max = frets.length ? Math.max(...frets) : 0;
  const start = min>1 ? min : 1;
  const span = Math.max(4, max-start+1);

  const w=140,h=170,left=8,top=18,right=8,bottom=12;
  const gridW=w-left-right, gridH=h-top-bottom;
  const dx=gridW/5, dy=gridH/span;

  let svg = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">`;
  svg += `<rect x="0" y="0" width="${w}" height="${h}" rx="12" fill="#0f1330" stroke="#202858"/>`;

  for(let s=0;s<6;s++){ const x=left+s*dx;
    svg += `<line x1="${x}" y1="${top}" x2="${x}" y2="${top+gridH}" stroke="#44508a" stroke-width="1"/>`;
  }
  for(let f=0; f<=span; f++){ const y=top+f*dy;
    const thick=(start===1 && f===0)?3:1.5;
    svg += `<line x1="${left}" y1="${y}" x2="${left+gridW}" y2="${y}" stroke="#44508a" stroke-width="${thick}"/>`;
  }
  arr.forEach((v, i)=>{
    const x=left+i*dx;
    if(v===0) svg += `<circle cx="${x}" cy="${top-8}" r="5" fill="none" stroke="#ffd8f2" stroke-width="2"/>`;
    else if(v<0) svg += `<text x="${x-4}" y="${top-6}" fill="#ffd8f2" font-size="12">x</text>`;
    else{
      const fret=v-start+1, y=top+fret*dy-dy/2;
      svg += `<circle cx="${x}" cy="${y}" r="8" fill="#f58ad6"/>`;
    }
  });
  if(start>1){
    svg += `<rect x="${w-34}" y="6" rx="6" width="28" height="16" fill="#1b2240" stroke="#2a3260"/>`;
    svg += `<text x="${w-21}" y="18" fill="#b3c4ff" font-size="12" text-anchor="middle">${start}</text>`;
  }
  svg += `</svg>`;
  return svg;
}

function openPopover(chord, x, y){
  const shape = CHORD_SHAPES[chord];
  if(!shape) return;
  if(!pop){ pop = document.createElement('div'); pop.className='popover'; document.body.appendChild(pop); }
  pop.innerHTML = `
    <div class="pop-title"><h4>${chord}</h4><span class="badge">${encodeShape(shape)}</span></div>
    <div class="fret-wrap">
      <div class="strings"><span>E</span><span>A</span><span>D</span><span>G</span><span>B</span><span>e</span></div>
      <div class="fret">${drawChord(chord, shape)}</div>
    </div>
    <div class="pop-foot"><span>Негізгі аппликатура</span><button class="pop-close">Жабу</button></div>
  `;
  const px = Math.min(window.innerWidth-260, Math.max(12, x+12));
  const py = Math.min(window.innerHeight-260, Math.max(12, y-20));
  pop.style.left = px+'px'; pop.style.top = py+'px';
  pop.querySelector('.pop-close').onclick = closePopover;
  window.addEventListener('keydown', escClose);
}
function closePopover(){ if(pop){ pop.remove(); pop=null; window.removeEventListener('keydown', escClose);} }
function escClose(e){ if(e.key==='Escape') closePopover(); }

// оборачиваем все аккорды в кликабельные спаны при загрузке
function wrapInlineChords(){
  document.querySelectorAll('.chrd').forEach(el=>{
    const text = el.textContent.trim();
    el.innerHTML = text.split(/\s+/)
      .map(tok => `<span class="chx" data-chord="${tok}">${tok}</span>`).join(' ');
  });
}
wrapInlineChords();

// клик по аккорду
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.chx, .chip.chrd');
  if(btn){
    const chord = (btn.dataset.chord||btn.textContent).trim();
    const r = btn.getBoundingClientRect();
    openPopover(chord, r.left + r.width/2, r.top + window.scrollY + r.height + 8);
  } else if(!e.target.closest('.popover')){
    closePopover();
  }
});
  </script>
</body>
</html>
